<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="theme-color" content="#ffcd21">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="style.css" />
<link rel="manifest" href="manifest.json" />
<link rel="icon" href="assets/icon-192.png" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<title>YÃœDÃœ - Film YÃ¼ksek mi DÃ¼ÅŸÃ¼k mÃ¼?</title>
</head>
<body>
  <button class="theme-toggle" id="toggleThemeBtn" aria-label="Tema deÄŸiÅŸtir">ğŸŒ™</button>

  <main class="container" role="main" aria-live="polite">
    <h2>YÃœDÃœ - Film YÃ¼ksek mi DÃ¼ÅŸÃ¼k mÃ¼?</h2>

    <section id="introText">
      Bu oyun, verilen iki filmden ikinci filmin IMDb puanÄ±nÄ±n birincisinden daha yÃ¼ksek mi yoksa daha dÃ¼ÅŸÃ¼k mÃ¼ olduÄŸunu tahmin etme oyunudur.<br>
      Zaman sÄ±nÄ±rlÄ±dÄ±r, doÄŸru tahmin etmeye Ã§alÄ±ÅŸ!
    </section>

    <article class="card" id="card1" aria-label="Birinci film" style="display:none;">
      <div id="item1Name" class="item-name">
        <img id="item1Flag" src="" alt="Film posteri" style="width:40px; height:auto; vertical-align:middle; border-radius:4px; margin-right:8px;" />
        <span id="item1Text">...</span>
      </div>
      <div id="item1Value" class="value" aria-live="polite">?</div>
    </article>

    <div id="timer" aria-label="Kalan sÃ¼re" style="display:none;">
      <div id="timer-fill"></div>
    </div>

    <div class="options" role="group" aria-label="Tahmin seÃ§enekleri" style="display:none;">
      <button id="btnHigher" onclick="checkGuess('higher')" disabled>Daha YÃ¼ksek</button>
      <button id="btnLower" onclick="checkGuess('lower')" disabled>Daha DÃ¼ÅŸÃ¼k</button>
    </div>

    <article class="card" id="card2" aria-label="Ä°kinci film" style="display:none;">
      <div id="item2Name" class="item-name">
        <img id="item2Flag" src="" alt="Film posteri" style="width:40px; height:auto; vertical-align:middle; border-radius:4px; margin-right:8px;" />
        <span id="item2Text">...</span>
      </div>
      <div id="item2Value" class="value hidden" aria-live="polite">?</div>
    </article>

    <div class="best-score">En iyi skor: <span id="bestScoreFilm">0</span></div>
    <div id="scoreText" style="display:none;">Skor: 0</div>

    <button id="btnAnasayfa" class="btn-secondary" onclick="window.location.href='index.html'">Anasayfa</button>
    <button id="btnStart" class="btn-secondary" onclick="startGame()">Oyuna BaÅŸla</button>

    <section id="gameOver" role="alert" style="display:none;">
      <p>Oyun Bitti! Toplam Skorun: <strong id="finalScore">0</strong></p>
      <button class="btn-secondary" id="btnRestart" onclick="startGame()">Yeniden BaÅŸla</button>
      <button class="btn-secondary" id="btnShare" onclick="copyShare()">Skorunu PaylaÅŸ</button>
      <button id="btnAnasayfa" class="btn-secondary" onclick="window.location.href='index.html'">Anasayfa</button>
    </section>
  </main>

<script>
  // Film verisini dÄ±ÅŸarÄ±dan yÃ¼kle
  async function fetchFilms() {
    try {
      const response = await fetch("datasets/film.json");
      if (!response.ok) throw new Error("Film verisi yÃ¼klenemedi");
      const json = await response.json();
      // Senin verdiÄŸin JSON yapÄ±sÄ±nda root altÄ±nda dizi var, ona gÃ¶re ayarla:
      // EÄŸer filmler json.root ise:
      return json.root.map(film => ({
        name: `${film.title} (${film.year})`,
        value: parseFloat(film.rating),
        extra: "IMDb PuanÄ±",
        image: film.image
      }));
    } catch (e) {
      alert("Veri alÄ±namadÄ±, internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.");
      return [];
    }
  }

  let items = [];
  async function initData() {
    items = await fetchFilms();
    if (items.length > 0) {
      console.log("Film verisi yÃ¼klendi:", items.length, "film");
    }
  }
  initData();

  let score = 0;
  let currentPair = [];
  let usedPairs = new Set();
  let buttonsDisabled = false;
  let darkMode = localStorage.getItem('darkMode') === 'true';

  const card1 = document.getElementById('card1');
  const card2 = document.getElementById('card2');
  const item1Name = document.getElementById('item1Name');
  const item1Value = document.getElementById('item1Value');
  const item2Name = document.getElementById('item2Name');
  const item2Value = document.getElementById('item2Value');
  const scoreText = document.getElementById('scoreText');
  const gameOverDiv = document.getElementById('gameOver');
  const finalScore = document.getElementById('finalScore');
  const btnHigher = document.getElementById('btnHigher');
  const btnLower = document.getElementById('btnLower');
  const btnStart = document.getElementById('btnStart');
  const btnAnasayfa = document.getElementById('btnAnasayfa');
  const btnRestart = document.getElementById('btnRestart');
  const btnShare = document.getElementById('btnShare');
  const toggleThemeBtn = document.getElementById('toggleThemeBtn');
  const timerBar = document.getElementById('timer-fill');

  const TIMER_DURATION = 7000; // 7 saniye
  let timerInterval = null;
  let timerStart = null;

  // Ses efektleri
  const audioCorrect = new Audio("sound/ding.mp3");
  const audioWrong = new Audio("sound/error.mp3");

  // Tema fonksiyonlarÄ±
  function applyTheme() {
    if (darkMode) {
      document.documentElement.setAttribute('data-theme', 'dark');
      toggleThemeBtn.textContent = 'â˜€ï¸';
    } else {
      document.documentElement.setAttribute('data-theme', 'light');
      toggleThemeBtn.textContent = 'ğŸŒ™';
    }
    localStorage.setItem('darkMode', darkMode);
  }
  toggleThemeBtn.addEventListener('click', () => {
    darkMode = !darkMode;
    applyTheme();
  });
  applyTheme();

  // Rastgele film Ã§ifti seÃ§
  function getRandomPair() {
    if (usedPairs.size >= items.length * (items.length -1) / 2) {
      usedPairs.clear();
    }
    let i1, i2, key;
    do {
      i1 = Math.floor(Math.random() * items.length);
      do {
        i2 = Math.floor(Math.random() * items.length);
      } while (i2 === i1);
      key = i1 < i2 ? `${i1}-${i2}` : `${i2}-${i1}`;
    } while (usedPairs.has(key));
    usedPairs.add(key);
    return [items[i1], items[i2]];
  }

  function setCardsVisibility(showSecondValue) {
    if (showSecondValue) {
      item2Value.classList.remove('hidden');
    } else {
      item2Value.classList.add('hidden');
      item2Value.textContent = '?';
    }
  }

  function disableButtons(val) {
    btnHigher.disabled = val;
    btnLower.disabled = val;
    buttonsDisabled = val;
  }

  function updateScore() {
    scoreText.textContent = `Skor: ${score}`;
  }

  function resetTimer() {
    clearInterval(timerInterval);
    timerBar.style.width = '100%';
    timerStart = Date.now();

    timerInterval = setInterval(() => {
      const elapsed = Date.now() - timerStart;
      const percent = Math.max(0, 100 - (elapsed / TIMER_DURATION) * 100);
      timerBar.style.width = percent + '%';

      if (percent <= 0) {
        clearInterval(timerInterval);
        if (!buttonsDisabled) {
          disableButtons(true);
          showResult(false);
          updateHighScoreFilm(score);
        }
      }
    }, 50);
  }

  function nextRound() {
    setCardsVisibility(false);
    currentPair = getRandomPair();

    document.getElementById('item1Text').textContent = currentPair[0].name;
    document.getElementById('item1Flag').src = currentPair[0].image;
    document.getElementById('item1Flag').alt = currentPair[0].name + " posteri";
    item1Value.textContent = currentPair[0].value.toLocaleString();

    document.getElementById('item2Text').textContent = currentPair[1].name;
    document.getElementById('item2Flag').src = currentPair[1].image;
    document.getElementById('item2Flag').alt = currentPair[1].name + " posteri";
    item2Value.textContent = '?';

    card1.classList.remove('correct', 'wrong');
    card2.classList.remove('correct', 'wrong');

    disableButtons(false);
    gameOverDiv.style.display = 'none';

    resetTimer();
  }

  function showResult(isCorrect) {
    setCardsVisibility(true);
    const val1 = currentPair[0].value;
    const val2 = currentPair[1].value;

    if (isCorrect) {
      score++;
      updateScore();
      card2.classList.add('correct');
      audioCorrect.play().catch(() => {});
      setTimeout(nextRound, 1200);
    } else {
      card2.classList.add('wrong');
      audioWrong.play().catch(() => {});
      finalScore.textContent = score;
      updateHighScoreFilm(score);

      // Oyun sonu gÃ¶rÃ¼nÃ¼mÃ¼
      card1.style.display = 'none';
      card2.style.display = 'none';
      document.getElementById('timer').style.display = 'none';
      document.querySelector('.options').style.display = 'none';
      scoreText.style.display = 'none';
      gameOverDiv.style.display = 'block';

      score = 0;
      updateScore();
    }
  }

  function checkGuess(choice) {
    if (buttonsDisabled) return;
    disableButtons(true);
    clearInterval(timerInterval);

    const val1 = currentPair[0].value;
    const val2 = currentPair[1].value;

    const correct = (choice === 'higher' && val2 > val1) || (choice === 'lower' && val2 < val1);
    showResult(correct);
  }

  function copyShare() {
    const score = finalScore?.textContent?.trim() || "0";
    const mainUrl = "https://yu-du.vercel.app";
    const shareText = `YÃœDÃœ: Film Tahmini oyununda ${score} puan yaptÄ±m! Sen de dene: ${mainUrl}`;

    const isMobile = /Mobi|Android/i.test(navigator.userAgent);

    if (isMobile && navigator.share) {
      navigator.share({
        title: "YÃœDÃœ: Film Tahmini",
        text: shareText
      }).catch(() => {
        fallbackCopyToClipboard(shareText);
      });
    } else {
      fallbackCopyToClipboard(shareText);
    }
  }

  function fallbackCopyToClipboard(text) {
    if (navigator.clipboard) {
      navigator.clipboard.writeText(text).then(() => {
        alert("PaylaÅŸÄ±m panoya kopyalandÄ±!");
      }).catch(() => {
        legacyCopyToClipboard(text);
      });
    } else {
      legacyCopyToClipboard(text);
    }
  }

  function legacyCopyToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.left = "-9999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
      document.execCommand('copy');
      alert("Mesaj panoya kopyalandÄ±!");
    } catch (e) {}
    document.body.removeChild(textArea);
  }

  function startGame() {
    if (items.length < 2) {
      alert("Veri henÃ¼z yÃ¼klenmedi. LÃ¼tfen sayfayÄ± yeniden yÃ¼kleyin.");
      return;
    }
    document.getElementById('introText').style.display = 'none';
    btnStart.style.display = 'none';
    btnAnasayfa.style.display = 'none';

    card1.style.display = 'block';
    card2.style.display = 'block';
    document.getElementById('timer').style.display = 'block';
    document.querySelector('.options').style.display = 'flex';
    scoreText.style.display = 'block';
    gameOverDiv.style.display = 'none';

    score = 0;
    updateScore();
    nextRound();
  }

  function updateHighScoreFilm(currentScore) {
    const best = localStorage.getItem('highScoreFilm') || 0;
    if (currentScore > best) {
      localStorage.setItem('highScoreFilm', currentScore);
      document.getElementById('bestScoreFilm').textContent = currentScore;
    }
  }

  function displayBestFilmScore() {
    const best = localStorage.getItem('highScoreFilm') || 0;
    document.getElementById('bestScoreFilm').textContent = best;
  }

  displayBestFilmScore();

  // Service worker varsa kaydet
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/service-worker.js")
      .then(() => console.log("âœ… Service Worker kayÄ±t edildi"))
      .catch((err) => console.error("âŒ Hata:", err));
  }
</script>
</body>
</html>
